import Foundation

final class Logger {
    @Dependency(\.printer)
    private var print: Printer
    private var numberOfMutationPoints: Int = 0
    private var progressBar: ProgressBar!

    func launched() {
        print(
            """
            \(muterLogoForTerminal)

            Automated mutation testing for Swift ğŸ•³ï¸

            You are running version \("\(version)".bold)

            Want help? Have suggestions? Want to get involved?
             â†³ https://github.com/muter-mutation-testing/muter/issues
            +--------------------------------------------------------+

            """
        )
    }

    func updateCheckStarted() {
        print("ğŸ” Checking for new versions...")
    }

    func updateCheckFinished(newVersion: String?) {
        if let newVersion {
            print("ğŸ‰ New version \(newVersion) available!")
        } else {
            print("âœ… You are already using the latest of Muter")
        }
    }

    func projectCopyStarted() {
        print("âœ‚ï¸ Copying your project to a temporary directory for testing...")
    }

    func projectCopyFinished(destinationPath: String) {
        print(
            """
            âœ… Finished copying your project to a temporary directory for mutation testing.
            You can find your copied project here:

            \(destinationPath.bold)

            This directory will also serve as a backup for any XCTest logs that are generated by running your test suite.
            """
        )
    }

    func projectCoverageDiscoveryStarted() {
        print("âš™ï¸ Running tests with coverage enabled to determine which files to mutate")
    }

    func projectCoverageDiscoveryFinished(success: Bool) {
        guard success == false else {
            return
        }

        print(
            """
            âŒ Gathering coverage failed.
            Proceeding with mutation testing anyway.
            Pass \("--skip-coverage argument".bold) to disable this step
            """
        )
    }

    func sourceFileDiscoveryStarted() {
        printMessage("ğŸ” Discovering Swift files which Muter will analyze...")
    }

    func sourceFileDiscoveryFinished(sourceFileCandidates: [String]) {
        let fileNames = sourceFileCandidates
            .map(URL.init(fileURLWithPath:))
            .map { $0.lastPathComponent }
            .joined(separator: "\n")
            .bold

        print("âœ… In total, Muter discovered \(sourceFileCandidates.count) Swift files\n\n\(fileNames)")
    }

    func mutationsDiscoveryStarted() {
        printMessage("ğŸ” Analyzing source files to find mutants which can be inserted into your project...")
    }

    func mutationsDiscoveryFinished(mutations: [SchemataMutationMapping]) {
        let numberOfFiles = mutations.count
        var filesSummary: [String: Int] = [:]

        for mutation in mutations {
            numberOfMutationPoints += mutation.mutationSchemata.count
            filesSummary[mutation.fileName] = mutation.mutationSchemata.count
        }

        print("âœ… In total, Muter discovered \(numberOfMutationPoints) mutants in \(numberOfFiles) files\n")
        for (fileName, mutantCount) in filesSummary {
            print("\(fileName) (\(mutantCount) mutants)".bold)
        }
    }

    func mutationTestingStarted() {
        printMessage(
            """
            ğŸš€ Mutation testing will now begin
            âš™ï¸ Running your test suite to determine a baseline for mutation testing...
            """
        )
    }

    func newMutationTestLogAvailable(mutationTestLog: MutationTestLog) {
        if mutationTestLog.mutationPoint == nil {
            print(
                """
                ğŸ“Š Determined baseline for mutation testing.
                ğŸ§Ÿ Muter is now going to apply each mutant one at a time and run your test suite for each mutant.
                ğŸ“ƒ After this step, Muter will generate a report detailing the efficacy of your test suite.
                â˜•ï¸ This step may take a while.

                """
            )

            progressBar = ProgressBar(
                count: numberOfMutationPoints,
                configuration: [
                    ProgressString(string: "Inserting mutant"),
                    ProgressOneIndexed(),
                    ProgressString(string: "\nPercentage complete: "),
                    ProgressPercent(),
                    ColoredProgressBarLine(barLength: 50),
                    SimpleTimeEstimate(
                        initialEstimate: Double(mutationTestLog.remainingMutationPointsCount!) * mutationTestLog
                            .timePerBuildTestCycle!
                    ),
                ],
                printer: ProgressBarMultilineTerminalPrinter(numberOfLines: 2)
            )
        }

        progressBar.next()
    }

    func mutationTestingFinished(
        report: String,
        reportPath: String,
        isExportingReport: Bool,
        didSaveReport: Bool
    ) {
        print("ğŸ Muter finished running!")

        guard isExportingReport else {
            return print(
                """
                ğŸ“ Muter's report

                \(report)
                """
            )
        }

        if didSaveReport {
            print("ğŸ“ Report generated: \(reportPath.bold)")
        } else {
            print(report)
            print("\n")
            print("Could not save report!")
        }
    }

    func testPlanFileCreated(atPath path: String?) {
        if let path {
            print("ğŸ’¾ Mutation test plan created: \(path)")
        } else {
            print("ğŸ’¾ Mutation test plan created")
        }
    }

    func configurationFileCreated(atPath path: String?) {
        if let path {
            print("ğŸ’¾ Configuration file created at: \(path)")
        }
    }

    func muterMutationTestPlanLoaded() {
        print("â¬†ï¸ Muter mutation test plan loaded")
    }

    func print(_ message: String) {
        Swift.print(message)
    }

    private func printMessage(_ message: String) {
        print("+-----------------+")
        print(message)
    }
}
